{% extends 'base.html' %}
{% block title %}ƒ∞≈ülemler{% endblock %}

{% block content %}
  <h1 class="mb-3">ƒ∞≈ülemler</h1>

  <form id="filter-form" class="card p-3 mb-4 shadow-sm" method="get" action="{{ url_for('main.show_transactions') }}">
    <div class="d-flex flex-wrap align-items-center gap-3">
      <!-- Her filtre alanƒ± i√ßin label + input container -->
      <div class="filter-group">
        <label for="filter-account" class="filter-label">Hesap</label>
        <select name="account" id="filter-account" class="form-select form-select-sm auto-submit filter-input">
          <option value="">T√ºm√º</option>
          {% for acc in accounts %}
            <option value="{{ acc.id }}" {% if filter.account == acc.id %}selected{% endif %}>{{ acc.name }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-category" class="filter-label">Kategori</label>
        <select name="category" id="filter-category" class="form-select form-select-sm auto-submit filter-input">
          <option value="">T√ºm√º</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if filter.category == cat.id %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label for="filter-start" class="filter-label">Ba≈ülangƒ±√ß</label>
        <input type="date" name="start" id="filter-start" class="form-control form-control-sm auto-submit filter-input" value="{{ filter.start }}">
      </div>

      <div class="filter-group">
        <label for="filter-end" class="filter-label">Biti≈ü</label>
        <input type="date" name="end" id="filter-end" class="form-control form-control-sm auto-submit filter-input" value="{{ filter.end }}">
      </div>

      <div class="ms-auto d-flex gap-2 flex-shrink-0">
        <button type="button" id="clear-filters" class="btn btn-outline-secondary btn-sm">Temizle</button>
        <button id="add-row" class="btn btn-success btn-sm" type="button">Yeni Satƒ±r Ekle</button>
        <button id="global-undo-btn" class="btn btn-warning btn-sm" type="button" disabled>Son ƒ∞≈ülemi Geri Al</button>
      </div>
    </div>
  </form>

  <style>
    /* Apple-style filter form */
    .filter-group {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: auto;
      margin-right: 8px;
    }

    .filter-label {
      width: 75px;
      white-space: nowrap;
      font-weight: 500;
      color: #1d1d1f;
      margin-bottom: 0;
      text-align: right;
      font-size: 13px;
    }

    .filter-input {
      width: 160px;
      min-width: unset;
      height: 30px;
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 6px !important;
      border-color: #d2d2d7;
      background-color: #ffffff;
      transition: all 0.2s ease;
    }

    .filter-input:hover {
      border-color: #86b7fe;
    }

    .filter-input:focus {
      border-color: #006edc;
      box-shadow: 0 0 0 3px rgba(0,125,250,0.15);
    }

    /* Buttons in filter form */
    #filter-form .btn {
      padding: 4px 12px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 6px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    #filter-form .btn-success {
      background-color: #007aff;
      border-color: #007aff;
    }

    #filter-form .btn-warning {
      background-color: #ff9500;
      border-color: #ff9500;
    }

    #filter-form .btn-outline-secondary {
      border-color: #d2d2d7;
      color: #1d1d1f;
    }

    #filter-form .btn-outline-secondary:hover {
      background-color: #f5f5f7;
      border-color: #d2d2d7;
    }

    /* Responsive adjustments */
    @media (max-width: 900px) {
      .filter-group {
        width: 100%;
        margin-right: 0;
      }

      .filter-label {
        width: 85px;
        text-align: left;
      }

      .filter-input {
        width: 100%;
      }

      #filter-form .d-flex.flex-wrap {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
      }

      #filter-form .ms-auto {
        margin-left: 0 !important;
        margin-top: 12px;
        justify-content: flex-start !important;
        gap: 8px !important;
      }

      #filter-form .btn {
        flex: 1;
      }
    }
  </style>

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>Tarih</th>
          <th>Hesap</th>
          <th>Kategori</th>
          <th class="text-end">Tutar</th>
          <th>A√ßƒ±klama</th>
          <th>ƒ∞≈ülem</th>
          <th>Geri Al</th>
          <th>Sil</th> <!-- Yeni s√ºtun -->
        </tr>
      </thead>
      <tbody>
        {% for tr in transactions %}
        <tr data-id="{{ tr.id }}">
          <td>
            <input type="date"
                   class="form-control form-control-sm field"
                   data-field="date"
                   value="{{ tr.date }}">
          </td>
          <td>
            <select class="form-select form-select-sm field" data-field="account">
              {% for acc in accounts %}
                <option value="{{ acc.id }}" {% if tr.account_id == acc.id %}selected{% endif %}>{{ acc.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <select class="form-select form-select-sm field" data-field="category">
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if tr.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
              {% endfor %}
            </select>
          </td>
          <td>
            <input type="number" step="0.01"
                   class="form-control form-control-sm field text-end"
                   data-field="amount"
                   value="{{ '%.2f'|format(tr.amount) }}">
          </td>
          <td class="position-relative">
            <input type="text"
                   class="form-control form-control-sm field desc-input"
                   data-field="description"
                   autocomplete="off"
                   value="{{ tr.description }}">
            <ul class="list-group suggestion-list position-absolute w-100 d-none"></ul>
          </td>
          <td></td>
          <td>
            <button class="btn btn-sm btn-outline-secondary undo-btn">‚ü≤</button>
          </td>
          <td>
            <button class="btn btn-sm btn-danger delete-btn">üóëÔ∏è</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterForm = document.getElementById('filter-form');

      // Otomatik filtre submit
      document.querySelectorAll('.auto-submit').forEach(el => {
        el.addEventListener('change', () => filterForm.submit());
      });

      // Temizle butonu
      document.getElementById('clear-filters').addEventListener('click', () => {
        document.getElementById('filter-account').value = '';
        document.getElementById('filter-category').value = '';
        document.getElementById('filter-start').value = '';
        document.getElementById('filter-end').value = '';
        filterForm.submit();
      });

      // Inline edit & undo
      const originalData = {};
      document.querySelectorAll('tbody tr').forEach(tr => {
        const id = tr.dataset.id;
        originalData[id] = {};
        tr.querySelectorAll('.field').forEach(el => {
          originalData[id][el.dataset.field] = el.value;
        });
      });
      document.querySelectorAll('.field').forEach(el => {
        el.addEventListener('change', function() {
          const tr = this.closest('tr');
          const id = tr.dataset.id;
          const field = this.dataset.field;
          const value = this.value;
          // Validation
          if (field === 'amount' && isNaN(parseFloat(value))) {
            alert('Tutar ge√ßerli bir sayƒ± olmalƒ±!');
            this.value = originalData[id][field];
            return;
          }
          if (field === 'date' && !/^\d{4}-\d{2}-\d{2}$/.test(value)) {
            alert('Tarih formatƒ± YYYY-MM-DD olmalƒ±!');
            this.value = originalData[id][field];
            return;
          }
          fetch(`/transactions/${id}/update_field`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field: field, value: value })
          })
          .then(r => r.json())
          .then(data => {
            if (!data.success) {
              alert('G√ºncelleme ba≈üarƒ±sƒ±z');
              this.value = originalData[id][field];
            } else {
              this.classList.add('is-valid');
              setTimeout(() => this.classList.remove('is-valid'), 1000);
            }
          });
        });
      });
      document.querySelectorAll('.undo-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tr = this.closest('tr');
          const id = tr.dataset.id;
          Object.entries(originalData[id]).forEach(([field, val]) => {
            const el = tr.querySelector(`[data-field="${field}"]`);
            if (!el) return;
            el.value = val;
            fetch(`/transactions/${id}/update_field`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ field: field, value: val })
            });
          });
        });
      });

      // A√ßƒ±klama autocomplete fonksiyonu
      // A√ßƒ±klama autocomplete fonksiyonu (g√ºncellenmi≈ü)
      function attachAutocomplete(input) {
        const ul = input.parentElement.querySelector('.suggestion-list');
        let debounceTimer;
        input.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          const q = this.value.trim();
          if (q.length < 2) {
            ul.classList.add('d-none');
            return;
          }
          debounceTimer = setTimeout(() => {
            fetch(`/transactions/suggest?q=${encodeURIComponent(q)}`)
              .then(res => res.json())
              .then(list => {
                const uniq = [];
                const seen = new Set();
                list.forEach(item => {
                  const key = `${item.description}||${item.account_id}||${item.category_id}`;
                  if (!seen.has(key)) {
                    seen.add(key);
                    uniq.push(item);
                  }
                });
                ul.innerHTML = '';
                if (uniq.length === 0) {
                  ul.classList.add('d-none');
                  return;
                }
                uniq.forEach(item => {
                  const li = document.createElement('li');
                  li.className = 'list-group-item list-group-item-action py-1';
                  li.textContent = item.description;
                  li.dataset.account = item.account_id;
                  li.dataset.category = item.category_id;
                  li.dataset.amount = item.amount;
                  ul.appendChild(li);
                });
                ul.classList.remove('d-none');
              });
          }, 300);
        });

        ul.addEventListener('click', function(e) {
          if (e.target.tagName !== 'LI') return;
          const li = e.target;
          input.value = li.textContent;
          ul.classList.add('d-none');
          const tr = input.closest('tr');
          tr.querySelector('select[data-field=\"account\"]').value = li.dataset.account;
          tr.querySelector('select[data-field=\"category\"]').value = li.dataset.category;
          tr.querySelector('input[data-field=\"amount\"]').value = parseFloat(li.dataset.amount).toFixed(2);
        });

        input.addEventListener('blur', () => {
          setTimeout(() => ul.classList.add('d-none'), 200);
        });
        input.addEventListener('focus', () => {
          if (input.value.trim().length >=2 && ul.children.length>0) {
            ul.classList.remove('d-none');
          }
        });
      }

      // Mevcut ve yeni satƒ±rlara ata
      document.querySelectorAll('.desc-input').forEach(inp => attachAutocomplete(inp));
      // Yeni satƒ±r ekleme kodunda da attachAutocomplete √ßaƒürƒ±sƒ± zaten var

      // Global undo deƒüi≈ükeni
      let lastAction = null;
      const undoBtn = document.getElementById('global-undo-btn');

      // localStorage'tan son i≈ülemi y√ºkle
      function loadLastAction() {
        try {
          const data = localStorage.getItem('lastAction');
          if (data) {
            lastAction = JSON.parse(data);
            setUndoActive(true);
          } else {
            lastAction = null;
            setUndoActive(false);
          }
        } catch {
          lastAction = null;
          setUndoActive(false);
        }
      }

      // localStorage'a son i≈ülemi kaydet
      function saveLastAction() {
        if (lastAction) {
          localStorage.setItem('lastAction', JSON.stringify(lastAction));
          setUndoActive(true);
        } else {
          localStorage.removeItem('lastAction');
          setUndoActive(false);
        }
      }

      function setUndoActive(active) {
        if (active) {
          undoBtn.disabled = false;
          undoBtn.classList.remove('btn-secondary');
          undoBtn.classList.add('btn-warning');
        } else {
          undoBtn.disabled = true;
          undoBtn.classList.remove('btn-warning');
          undoBtn.classList.add('btn-secondary');
        }
      }

      loadLastAction();

      // Inline edit
      document.querySelectorAll('.field').forEach(el => {
        el.addEventListener('change', function() {
          const tr = this.closest('tr');
          const id = tr.dataset.id;
          const field = this.dataset.field;
          const oldValue = tr.getAttribute('data-old-' + field) || this.defaultValue;
          const newValue = this.value;
          // Validation
          if (field === 'amount' && isNaN(parseFloat(newValue))) {
            alert('Tutar ge√ßerli bir sayƒ± olmalƒ±!');
            this.value = oldValue;
            return;
          }
          if (field === 'date' && !/^\d{4}-\d{2}-\d{2}$/.test(newValue)) {
            alert('Tarih formatƒ± YYYY-MM-DD olmalƒ±!');
            this.value = oldValue;
            return;
          }
          fetch(`/transactions/${id}/update_field`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field: field, value: newValue })
          })
          .then(r => r.json())
          .then(data => {
            if (!data.success) {
              alert('G√ºncelleme ba≈üarƒ±sƒ±z');
              this.value = oldValue;
            } else {
              lastAction = {
                type: 'update',
                id,
                field,
                oldValue,
                newValue
              };
              saveLastAction();
              this.classList.add('is-valid');
              setTimeout(() => this.classList.remove('is-valid'), 1000);
            }
          });
        });
      });

      // Silme butonu
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          if (!confirm('Bu i≈ülemi silmek istediƒüinize emin misiniz?')) return;
          const tr = this.closest('tr');
          const id = tr.dataset.id;
          const rowData = {};
          tr.querySelectorAll('.field').forEach(el => {
            rowData[el.dataset.field] = el.value;
          });
          lastAction = {
            type: 'delete',
            id,
            data: rowData
          };
          saveLastAction();
          fetch(`/transactions/${id}/delete`, { method: 'POST' }).then(() => tr.remove());
        });
      });

      // Yeni satƒ±r ekleme
      document.getElementById('add-row').addEventListener('click', function() {
        const tbody = document.querySelector('tbody');
        const tr = document.createElement('tr');
        tr.classList.add('new-row');
        tr.innerHTML = `
          <td><input type="date" class="form-control form-control-sm new-field" data-field="date" value="{{ current_date }}"></td>
          <td><select class="form-select form-select-sm new-field" data-field="account">
            {% for acc in accounts %}<option value="{{ acc.id }}">{{ acc.name }}</option>{% endfor %}
          </select></td>
          <td><select class="form-select form-select-sm new-field" data-field="category">
            {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
          </select></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm new-field text-end" data-field="amount" value="0.00"></td>
          <td class="position-relative">
            <input type="text" class="form-control form-control-sm new-field desc-input" data-field="description" autocomplete="off">
            <ul class="list-group suggestion-list position-absolute w-100 d-none"></ul>
          </td>
          <td colspan="2">
            <button class="btn btn-sm btn-success save-btn">‚úÖ Kaydet</button>
            <button class="btn btn-sm btn-secondary cancel-btn">‚ùå ƒ∞ptal</button>
          </td>`;
        tbody.prepend(tr);

        // Yeni row i√ßin autocomplete ata
        attachAutocomplete(tr.querySelector('.desc-input'));

        // Kaydet
        tr.querySelector('.save-btn').addEventListener('click', function() {
          const data = {};
          tr.querySelectorAll('.new-field').forEach(el => data[el.dataset.field] = el.value);
          fetch('/transactions/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(r => r.json())
          .then(res => {
            if (res.success) {
              lastAction = {
                type: 'create',
                id: res.id
              };
              saveLastAction();
              tr.remove();
              location.reload();
            } else alert('Olu≈üturma ba≈üarƒ±sƒ±z');
          });
        });
        // ƒ∞ptal
        tr.querySelector('.cancel-btn').addEventListener('click', () => tr.remove());
      });

      // Global Undo Butonu
      undoBtn.addEventListener('click', function() {
        if (!lastAction) return;
        if (lastAction.type === 'update') {
          fetch(`/transactions/${lastAction.id}/update_field`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field: lastAction.field, value: lastAction.oldValue })
          }).then(() => {
            lastAction = null;
            saveLastAction();
            location.reload();
          });
        } else if (lastAction.type === 'delete') {
          fetch('/transactions/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lastAction.data)
          }).then(() => {
            lastAction = null;
            saveLastAction();
            location.reload();
          });
        } else if (lastAction.type === 'create') {
          fetch(`/transactions/${lastAction.id}/delete`, {
            method: 'POST'
          }).then(() => {
            lastAction = null;
            saveLastAction();
            location.reload();
          });
        }
      });

    });
  </script>
{% endblock %}