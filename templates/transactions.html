{% extends 'base.html' %}
{% block title %}İşlemler{% endblock %}

{% block content %}
  <h1 class="mb-3">İşlemler</h1>

  <form id="filter-form" method="get" action="{{ url_for('main.show_transactions') }}">
    <div class="filter-form-content">
      <div class="filter-group">
        <label for="filter-account" class="filter-label">Hesap</label>
        <select name="account" id="filter-account" class="form-select form-select-sm auto-submit filter-input">
          <option value="">Tümü</option>
          {% for acc in accounts %}
            <option value="{{ acc.id }}" {% if filter.account == acc.id %}selected{% endif %}>{{ acc.name }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filter-category" class="filter-label">Kategori</label>
        <select name="category" id="filter-category" class="form-select form-select-sm auto-submit filter-input">
          <option value="">Tümü</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if filter.category == cat.id %}selected{% endif %}>{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="filter-group">
        <label for="filter-start" class="filter-label">Başlangıç</label>
        <input type="date" name="start" id="filter-start" class="form-control form-control-sm auto-submit filter-input" value="{{ filter.start }}">
      </div>

      <div class="filter-group">
        <label for="filter-end" class="filter-label">Bitiş</label>
        <input type="date" name="end" id="filter-end" class="form-control form-control-sm auto-submit filter-input" value="{{ filter.end }}">
      </div>

      <div class="filter-buttons">
        <button type="button" id="clear-filters" class="btn btn-outline-secondary btn-sm">Temizle</button>
        <button id="add-row" class="btn btn-success btn-sm" type="button">Yeni Satır Ekle</button>
        <button id="global-undo-btn" class="btn btn-warning btn-sm" type="button" disabled>Son İşlemi Geri Al</button>
      </div>
    </div>
  </form>

  <div class="table-container">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Tarih</th>
            <th>Hesap</th>
            <th>Kategori</th>
            <th class="text-end">Tutar</th>
            <th>Açıklama</th>
            <th>İşlem</th>
            <th>Sil</th>
          </tr>
        </thead>
        <tbody>
          {% for tr in transactions %}
          <tr data-id="{{ tr.id }}">
            <td>
              <input type="date"
                     class="form-control form-control-sm field"
                     data-field="date"
                     value="{{ tr.date }}">
            </td>
            <td>
              <select class="form-select form-select-sm field" data-field="account">
                {% for acc in accounts %}
                  <option value="{{ acc.id }}" {% if tr.account_id == acc.id %}selected{% endif %}>{{ acc.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select class="form-select form-select-sm field" data-field="category">
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {% if tr.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="number" step="0.01"
                     class="form-control form-control-sm field text-end"
                     data-field="amount"
                     value="{{ '%.2f'|format(tr.amount) }}">
            </td>
            <td class="position-relative">
              <input type="text"
                     class="form-control form-control-sm field desc-input"
                     data-field="description"
                     autocomplete="off"
                     value="{{ tr.description }}">
              <div class="suggestion-list d-none">
                <!-- Suggestions will be dynamically added here with all necessary data attributes -->
              </div>
            </td>
            <td></td>
            <td>
              <button class="btn btn-sm btn-danger delete-btn" title="Sil">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M2 4h12M5.333 4V2.667a1.333 1.333 0 011.334-1.334h2.666a1.333 1.333 0 011.334 1.334V4m2 0v9.333a1.333 1.333 0 01-1.334 1.334H4.667a1.333 1.333 0 01-1.334-1.334V4h9.334z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterForm = document.getElementById('filter-form');

      // Otomatik filtre submit
      document.querySelectorAll('.auto-submit').forEach(el => {
        el.addEventListener('change', () => filterForm.submit());
      });

      // Temizle butonu
      document.getElementById('clear-filters').addEventListener('click', () => {
        document.getElementById('filter-account').value = '';
        document.getElementById('filter-category').value = '';
        document.getElementById('filter-start').value = '';
        document.getElementById('filter-end').value = '';
        filterForm.submit();
      });

      // Inline edit & undo
      const originalData = {};
      document.querySelectorAll('tbody tr').forEach(tr => {
        const id = tr.dataset.id;
        originalData[id] = {};
        tr.querySelectorAll('.field').forEach(el => {
          originalData[id][el.dataset.field] = el.value;
        });
      });
      // Alan değişikliği dinleyicisi
      document.querySelectorAll('.field').forEach(el => {
        el.addEventListener('change', function() {
          const tr = this.closest('tr');
          const id = tr.dataset.id;
          const field = this.dataset.field;
          const value = this.value;

          // Değişiklik yapmadan önceki orijinal değerleri sakla
          const originalState = { ...originalData[id] };

          fetch(`/transactions/${id}/update_field`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              field: field, 
              value: value,
              oldData: originalState  // Orijinal durumu gönder
            })
          })
          .then(r => r.json())
          .then(data => {
            if (!data.success) {
              alert('Güncelleme başarısız: ' + (data.error || ''));
              this.value = originalData[id][field];
            } else {
              // Başarılı güncelleme - lastAction'ı güncelle
              lastAction = {
                type: 'update',
                id: id,
                old_data: originalState  // Orijinal durumu sakla
              };
              saveLastAction();
              
              // Başarılı güncelleme sonrası originalData'yı güncelle
              originalData[id][field] = value;
              
              this.classList.add('is-valid');
              setTimeout(() => this.classList.remove('is-valid'), 1000);

              // Debug için konsola yaz
              console.log('Değişiklik öncesi değerler:', originalState);
              console.log('Güncel lastAction:', lastAction);
            }
          })
          .catch(error => {
            console.error('Hata:', error);
            alert('İşlem sırasında bir hata oluştu');
            this.value = originalData[id][field];
          });
        });
      });
      // document.querySelectorAll('.undo-btn').forEach(btn => {
      //   btn.addEventListener('click', function() {
      //     const tr = this.closest('tr');
      //     const id = tr.dataset.id;
      //     Object.entries(originalData[id]).forEach(([field, val]) => {
      //       const el = tr.querySelector(`[data-field="${field}"]`);
      //       if (!el) return;
      //       el.value = val;
      //       fetch(`/transactions/${id}/update_field`, {
      //         method: 'POST',
      //         headers: { 'Content-Type': 'application/json' },
      //         body: JSON.stringify({ field: field, value: val })
      //       });
      //     });
      //   });
      // });

      // Açıklama autocomplete fonksiyonu
      // Açıklama autocomplete fonksiyonu (güncellenmiş)
      function attachAutocomplete(input) {
        const ul = input.parentElement.querySelector('.suggestion-list');
        let debounceTimer;
        input.addEventListener('input', function() {
          clearTimeout(debounceTimer);
          const q = this.value.trim();
          if (q.length < 2) {
            ul.classList.add('d-none');
            ul.innerHTML = '';
            return;
          }
          
          debounceTimer = setTimeout(() => {
            fetch(`/transactions/suggest?q=${encodeURIComponent(q)}`)
                .then(res => res.json())
                .then(list => {
                    ul.innerHTML = '';
                    const uniq = [];
                    const seen = new Set();
                    
                    list.forEach(item => {
                        const key = `${item.description}||${item.account_id}||${item.category_id}`;
                        if (!seen.has(key)) {
                            seen.add(key);
                            uniq.push(item);
                        }
                    });

                    if (uniq.length === 0) {
                        ul.classList.add('d-none');
                        return;
                    }

                    uniq.forEach(item => {
                        const li = document.createElement('div');
                        li.className = 'list-group-item';
                        li.textContent = item.description;
                        li.dataset.account = item.account_id;
                        li.dataset.category = item.category_id;
                        li.dataset.amount = item.amount;
                        ul.appendChild(li);
                    });
                    
                    ul.classList.remove('d-none');
                });
        }, 300);
    });

        ul.addEventListener('click', function(e) {
          const item = e.target.closest('.list-group-item');
          if (!item) return;

          const tr = input.closest('tr');
          if (!tr) return;

          // Form alanlarını güncelle
          input.value = item.textContent;
          
          const accountSelect = tr.querySelector('[data-field="account"]');
          const categorySelect = tr.querySelector('[data-field="category"]');
          const amountInput = tr.querySelector('[data-field="amount"]');

          if (accountSelect) {
              accountSelect.value = item.dataset.account;
              accountSelect.dispatchEvent(new Event('change'));
          }

          if (categorySelect) {
              categorySelect.value = item.dataset.category;
              categorySelect.dispatchEvent(new Event('change'));
          }

          if (amountInput) {
              amountInput.value = Number(item.dataset.amount).toFixed(2);
              amountInput.dispatchEvent(new Event('change'));
          }

          // Öneri listesini gizle
          ul.classList.add('d-none');
          ul.innerHTML = '';
      });

        input.addEventListener('blur', () => {
          setTimeout(() => ul.classList.add('d-none'), 200);
        });
        input.addEventListener('focus', () => {
          if (input.value.trim().length >=2 && ul.children.length>0) {
            ul.classList.remove('d-none');
          }
        });
      }

      // Mevcut ve yeni satırlara ata
      document.querySelectorAll('.desc-input').forEach(inp => attachAutocomplete(inp));
      // Yeni satır ekleme kodunda da attachAutocomplete çağrısı zaten var

      // Global undo değişkeni
      let lastAction = null;
      const undoBtn = document.getElementById('global-undo-btn');

      // localStorage'tan son işlemi yükle
      function loadLastAction() {
        try {
          const data = localStorage.getItem('lastAction');
          if (data) {
            lastAction = JSON.parse(data);
            setUndoActive(true);
          } else {
            lastAction = null;
            setUndoActive(false);
          }
        } catch {
          lastAction = null;
          setUndoActive(false);
        }
      }

      // localStorage'a son işlemi kaydet
      function saveLastAction() {
        if (lastAction) {
          localStorage.setItem('lastAction', JSON.stringify(lastAction));
          setUndoActive(true);
        } else {
          localStorage.removeItem('lastAction');
          setUndoActive(false);
        }
      }

      function setUndoActive(active) {
        if (active) {
          undoBtn.disabled = false;
          undoBtn.classList.remove('btn-secondary');
          undoBtn.classList.add('btn-warning');
        } else {
          undoBtn.disabled = true;
          undoBtn.classList.remove('btn-warning');
          undoBtn.classList.add('btn-secondary');
        }
      }

      loadLastAction();

      // Silme butonu
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          if (!confirm('Bu işlemi silmek istediğinize emin misiniz?')) return;
          const tr = this.closest('tr');
          const id = tr.dataset.id;
          const rowData = {};
          tr.querySelectorAll('.field').forEach(el => {
            rowData[el.dataset.field] = el.value;
          });
          lastAction = {
            type: 'delete',
            id,
            data: rowData
          };
          saveLastAction();
          fetch(`/transactions/${id}/delete`, { method: 'POST' }).then(() => tr.remove());
        });
      });

      // Yeni satır ekleme
      document.getElementById('add-row').addEventListener('click', function() {
        const tbody = document.querySelector('tbody');
        const tr = document.createElement('tr');
        tr.classList.add('new-row');
        tr.innerHTML = `
          <td><input type="date" class="form-control form-control-sm new-field" data-field="date" value="{{ current_date }}"></td>
          <td><select class="form-select form-select-sm new-field" data-field="account">
            {% for acc in accounts %}<option value="{{ acc.id }}">{{ acc.name }}</option>{% endfor %}
          </select></td>
          <td><select class="form-select form-select-sm new-field" data-field="category">
            {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
          </select></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm new-field text-end" data-field="amount" value="0.00"></td>
          <td class="position-relative">
            <input type="text" class="form-control form-control-sm new-field desc-input" data-field="description" autocomplete="off">
            <ul class="list-group suggestion-list position-absolute w-100 d-none"></ul>
          </td>
          <td colspan="2">
            <button class="btn btn-sm btn-success save-btn">✅ Kaydet</button>
            <button class="btn btn-sm btn-secondary cancel-btn">❌ İptal</button>
          </td>`;
        tbody.prepend(tr);

        // Yeni row için autocomplete ata
        attachAutocomplete(tr.querySelector('.desc-input'));

        // Kaydet
        tr.querySelector('.save-btn').addEventListener('click', function() {
          const data = {};
          tr.querySelectorAll('.new-field').forEach(el => data[el.dataset.field] = el.value);
          fetch('/transactions/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(r => r.json())
          .then(res => {
            if (res.success) {
              lastAction = {
                type: 'create',
                id: res.id
              };
              saveLastAction();
              tr.remove();
              location.reload();
            } else alert('Oluşturma başarısız');
          });
        });
        // İptal
        tr.querySelector('.cancel-btn').addEventListener('click', () => tr.remove());
      });

      // Global Undo Butonu
      undoBtn.addEventListener('click', function() {
        if (!lastAction) return;
        
        this.disabled = true;

        if (lastAction.type === 'update') {
          fetch('/transactions/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: 'update',
              id: lastAction.id,
              oldData: lastAction.old_data  // Saklanan eski değerler
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              lastAction = null;
              saveLastAction();
              location.reload();
            } else {
              alert('Geri alma işlemi başarısız: ' + (data.error || 'Bilinmeyen hata'));
              this.disabled = false;
            }
          });
        } else if (lastAction.type === 'delete') {
            fetch('/transactions/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lastAction.data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    lastAction = null;
                    saveLastAction();
                    location.reload();
                } else {
                    alert('Geri alma işlemi başarısız: ' + data.error);
                }
            });
        } else if (lastAction.type === 'create') {
            fetch(`/transactions/${lastAction.id}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    lastAction = null;
                    saveLastAction();
                    location.reload();
                } else {
                    alert('Geri alma işlemi başarısız: ' + data.error);
                }
            });
        }
      });

    });
  </script>
{% endblock %}